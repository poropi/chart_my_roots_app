# PDF設定画面 詳細設計書

## 1. 概要

PDF設定画面は、家系図をPDF形式で出力するための各種設定を行うモーダルダイアログです。用紙サイズや向き、タイトルなどの設定を行い、PDF生成やプレビュー表示を行うことができます。Flutter/Dartでの実装を前提とした詳細設計を記載します。

## 2. 画面構成

### 2.1 画面レイアウト

```dart
// lib/features/pdf_export/presentation/dialogs/pdf_settings_dialog.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:chart_my_roots_app/features/pdf_export/application/pdf_settings_controller.dart';
import 'package:chart_my_roots_app/features/pdf_export/application/pdf_export_controller.dart';
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:chart_my_roots_app/features/pdf_export/presentation/dialogs/pdf_preview_dialog.dart';
import 'package:pdf/pdf.dart';

class PdfSettingsDialog extends ConsumerWidget {
  const PdfSettingsDialog({Key? key}) : super(key: key);
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 現在のPDF設定を取得
    final pdfSettings = ref.watch(pdfSettingsProvider);
    
    // PDF生成状態を取得
    final pdfGenerationState = ref.watch(pdfGenerationStateProvider);
    
    // 生成中フラグ
    final isGenerating = pdfGenerationState.isGenerating;
    
    return AlertDialog(
      title: Text('PDF出力設定'),
      content: SingleChildScrollView(
        child: Container(
          width: double.maxFinite,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // タイトル設定
              _buildTitleField(ref, pdfSettings.title),
              
              SizedBox(height: 20),
              
              // 用紙サイズ設定
              _buildPaperSizeSection(ref, pdfSettings.pageFormat),
              
              SizedBox(height: 20),
              
              // 向き設定
              _buildOrientationSection(ref, pdfSettings.orientation),
              
              SizedBox(height: 20),
              
              // プレビュー表示
              _buildPreview(context, pdfSettings),
              
              SizedBox(height: 20),
              
              // 表示オプション設定
              _buildDisplayOptionsSection(ref, pdfSettings),
              
              // エラーメッセージ
              if (pdfGenerationState.errorMessage != null)
                Padding(
                  padding: const EdgeInsets.only(top: 16.0),
                  child: _buildErrorMessage(pdfGenerationState.errorMessage!),
                ),
              
              // 生成中インジケーター
              if (isGenerating)
                Padding(
                  padding: const EdgeInsets.only(top: 16.0),
                  child: Center(
                    child: Column(
                      children: [
                        CircularProgressIndicator(),
                        SizedBox(height: 8),
                        Text('PDFを生成中...'),
                      ],
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
      actions: [
        // キャンセルボタン
        TextButton(
          onPressed: isGenerating
              ? null
              : () {
                  Navigator.of(context).pop();
                },
          child: Text('キャンセル'),
        ),
        
        // プレビューボタン
        TextButton(
          onPressed: isGenerating
              ? null
              : () => _generatePdfForPreview(context, ref),
          child: Text('プレビュー'),
        ),
        
        // PDFを生成ボタン
        ElevatedButton(
          onPressed: isGenerating
              ? null
              : () => _generateAndDownloadPdf(context, ref),
          child: isGenerating
              ? SizedBox(
                  width: 20,
                  height: 20,
                  child: CircularProgressIndicator(
                    strokeWidth: 2,
                    valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                  ),
                )
              : Text('PDFを生成'),
        ),
      ],
    );
  }
  
  // タイトル入力フィールド
  Widget _buildTitleField(WidgetRef ref, String title) {
    return TextFormField(
      initialValue: title,
      decoration: InputDecoration(
        labelText: 'タイトル',
        hintText: 'PDFに表示するタイトル',
        border: OutlineInputBorder(),
      ),
      onChanged: (value) {
        ref.read(pdfSettingsProvider.notifier).updateTitle(value);
      },
    );
  }
  
  // 用紙サイズ設定セクション
  Widget _buildPaperSizeSection(WidgetRef ref, PdfPageFormat pageFormat) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          '用紙サイズ',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.blueGrey,
          ),
        ),
        
        RadioListTile<PdfPageFormat>(
          title: Text('A4'),
          subtitle: Text('210 × 297 mm'),
          value: PdfPageFormat.a4,
          groupValue: pageFormat,
          onChanged: (value) {
            if (value != null) {
              ref.read(pdfSettingsProvider.notifier).updatePageFormat(value);
            }
          },
          dense: true,
          contentPadding: EdgeInsets.zero,
        ),
        
        RadioListTile<PdfPageFormat>(
          title: Text('A3'),
          subtitle: Text('297 × 420 mm（A4の2倍の大きさ）'),
          value: PdfPageFormat.a3,
          groupValue: pageFormat,
          onChanged: (value) {
            if (value != null) {
              ref.read(pdfSettingsProvider.notifier).updatePageFormat(value);
            }
          },
          dense: true,
          contentPadding: EdgeInsets.zero,
        ),
        
        RadioListTile<PdfPageFormat>(
          title: Text('レターサイズ'),
          subtitle: Text('215.9 × 279.4 mm（US標準）'),
          value: PdfPageFormat.letter,
          groupValue: pageFormat,
          onChanged: (value) {
            if (value != null) {
              ref.read(pdfSettingsProvider.notifier).updatePageFormat(value);
            }
          },
          dense: true,
          contentPadding: EdgeInsets.zero,
        ),
      ],
    );
  }
  
  // 向き設定セクション
  Widget _buildOrientationSection(WidgetRef ref, PdfOrientation orientation) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          '向き',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.blueGrey,
          ),
        ),
        
        Row(
          children: [
            Expanded(
              child: RadioListTile<PdfOrientation>(
                title: Text('縦向き'),
                value: PdfOrientation.portrait,
                groupValue: orientation,
                onChanged: (value) {
                  if (value != null) {
                    ref.read(pdfSettingsProvider.notifier).updateOrientation(value);
                  }
                },
                dense: true,
                contentPadding: EdgeInsets.zero,
              ),
            ),
            
            Expanded(
              child: RadioListTile<PdfOrientation>(
                title: Text('横向き'),
                value: PdfOrientation.landscape,
                groupValue: orientation,
                onChanged: (value) {
                  if (value != null) {
                    ref.read(pdfSettingsProvider.notifier).updateOrientation(value);
                  }
                },
                dense: true,
                contentPadding: EdgeInsets.zero,
              ),
            ),
          ],
        ),
      ],
    );
  }
  
  // 表示オプション設定セクション
  Widget _buildDisplayOptionsSection(WidgetRef ref, PdfSettings settings) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          '表示オプション',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.blueGrey,
          ),
        ),
        
        CheckboxListTile(
          title: Text('日付を表示'),
          subtitle: Text('出力日を表示します'),
          value: settings.showDate,
          onChanged: (value) {
            if (value != null) {
              ref.read(pdfSettingsProvider.notifier).updateShowDate(value);
            }
          },
          dense: true,
          contentPadding: EdgeInsets.zero,
          controlAffinity: ListTileControlAffinity.leading,
        ),
        
        CheckboxListTile(
          title: Text('凡例を表示'),
          subtitle: Text('性別や関係性の説明を表示します'),
          value: settings.showLegend,
          onChanged: (value) {
            if (value != null) {
              ref.read(pdfSettingsProvider.notifier).updateShowLegend(value);
            }
          },
          dense: true,
          contentPadding: EdgeInsets.zero,
          controlAffinity: ListTileControlAffinity.leading,
        ),
        
        CheckboxListTile(
          title: Text('1ページに収める'),
          subtitle: Text('家系図全体を1ページに収めます（大きな家系図は縮小されます）'),
          value: settings.fitToSinglePage,
          onChanged: (value) {
            if (value != null) {
              ref.read(pdfSettingsProvider.notifier).updateFitToSinglePage(value);
            }
          },
          dense: true,
          contentPadding: EdgeInsets.zero,
          controlAffinity: ListTileControlAffinity.leading,
        ),
      ],
    );
  }
  
  // プレビュー表示
  Widget _buildPreview(BuildContext context, PdfSettings settings) {
    // プレビュー用のアスペクト比を計算
    double aspectRatio;
    if (settings.orientation == PdfOrientation.portrait) {
      aspectRatio = 210 / 297;  // A4の比率
    } else {
      aspectRatio = 297 / 210;  // A4横向きの比率
    }
    
    return Center(
      child: Column(
        children: [
          Text(
            'プレビュー',
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: Colors.blueGrey,
            ),
          ),
          
          SizedBox(height: 8),
          
          Container(
            width: 150,
            height: 180,
            decoration: BoxDecoration(
              border: Border.all(color: Colors.grey),
              color: Colors.grey.shade100,
            ),
            child: Center(
              child: AspectRatio(
                aspectRatio: aspectRatio,
                child: Container(
                  margin: EdgeInsets.all(10),
                  color: Colors.white,
                  child: Stack(
                    children: [
                      // タイトル
                      if (settings.title.isNotEmpty)
                        Positioned(
                          top: 5,
                          left: 0,
                          right: 0,
                          child: Center(
                            child: Text(
                              'タイトル',
                              style: TextStyle(fontSize: 8),
                            ),
                          ),
                        ),
                      
                      // 家系図プレースホルダー
                      Center(
                        child: Container(
                          width: 60,
                          height: 40,
                          decoration: BoxDecoration(
                            border: Border.all(color: Colors.grey),
                          ),
                          child: Center(
                            child: Text(
                              '家系図',
                              style: TextStyle(fontSize: 6),
                            ),
                          ),
                        ),
                      ),
                      
                      // フッター（日付）
                      if (settings.showDate)
                        Positioned(
                          bottom: 5,
                          left: 0,
                          right: 0,
                          child: Center(
                            child: Text(
                              '日付',
                              style: TextStyle(fontSize: 6),
                            ),
                          ),
                        ),
                      
                      // 凡例
                      if (settings.showLegend)
                        Positioned(
                          bottom: 15,
                          left: 5,
                          child: Container(
                            width: 20,
                            height: 10,
                            color: Colors.grey.shade200,
                            child: Center(
                              child: Text(
                                '凡例',
                                style: TextStyle(fontSize: 4),
                              ),
                            ),
                          ),
                        ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
  
  // エラーメッセージの表示
  Widget _buildErrorMessage(String message) {
    return Container(
      padding: EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: Colors.red.shade50,
        border: Border.all(color: Colors.red.shade200),
        borderRadius: BorderRadius.circular(4),
      ),
      child: Row(
        children: [
          Icon(Icons.error_outline, color: Colors.red),
          SizedBox(width: 8),
          Expanded(
            child: Text(
              message,
              style: TextStyle(color: Colors.red.shade800),
            ),
          ),
        ],
      ),
    );
  }
  
  // プレビュー用のPDF生成
  void _generatePdfForPreview(BuildContext context, WidgetRef ref) async {
    // 選択中の家系図データを取得
    final selectedTreeAsync = ref.read(selectedFamilyTreeStreamProvider);
    
    if (selectedTreeAsync.asData == null || selectedTreeAsync.asData!.value == null) {
      ref.read(pdfGenerationStateProvider.notifier).setError(
        '家系図データが見つかりません',
      );
      return;
    }
    
    final familyTreeData = selectedTreeAsync.asData!.value!;
    final pdfSettings = ref.read(pdfSettingsProvider);
    final pdfExportService = ref.read(pdfExportServiceProvider);
    
    try {
      // PDF生成を開始
      ref.read(pdfGenerationStateProvider.notifier).startGenerating();
      
      // PDFを生成
      final pdfData = await pdfExportService.generatePdf(
        familyTreeData: familyTreeData,
        settings: pdfSettings,
      );
      
      // 生成完了状態に更新
      ref.read(pdfGenerationStateProvider.notifier).setPdfData(pdfData);
      
      if (context.mounted) {
        // 設定ダイアログを閉じる
        Navigator.of(context).pop();
        
        // プレビューダイアログを表示
        showDialog(
          context: context,
          builder: (_) => PdfPreviewDialog(),
        );
      }
    } catch (e) {
      // エラー状態に更新
      ref.read(pdfGenerationStateProvider.notifier).setError(
        'PDF生成中にエラーが発生しました: ${e.toString()}',
      );
    }
  }
  
  // PDF生成とダウンロード
  void _generateAndDownloadPdf(BuildContext context, WidgetRef ref) async {
    // 選択中の家系図データを取得
    final selectedTreeAsync = ref.read(selectedFamilyTreeStreamProvider);
    
    if (selectedTreeAsync.asData == null || selectedTreeAsync.asData!.value == null) {
      ref.read(pdfGenerationStateProvider.notifier).setError(
        '家系図データが見つかりません',
      );
      return;
    }
    
    final familyTreeData = selectedTreeAsync.asData!.value!;
    final pdfSettings = ref.read(pdfSettingsProvider);
    final pdfExportService = ref.read(pdfExportServiceProvider);
    
    try {
      // PDF生成を開始
      ref.read(pdfGenerationStateProvider.notifier).startGenerating();
      
      // PDFを生成
      final pdfData = await pdfExportService.generatePdf(
        familyTreeData: familyTreeData,
        settings: pdfSettings,
      );
      
      // 生成完了状態に更新
      ref.read(pdfGenerationStateProvider.notifier).setPdfData(pdfData);
      
      // ファイル名の生成
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final sanitizedTitle = pdfSettings.title
          .replaceAll(RegExp(r'[\\/:*?"<>|]'), '_')
          .trim();
      final fileName = sanitizedTitle.isNotEmpty
          ? '${sanitizedTitle}_${timestamp}.pdf'
          : 'family_tree_${timestamp}.pdf';
      
      // PDFをダウンロード
      await pdfExportService.downloadPdf(pdfData, fileName);
      
      if (context.mounted) {
        // ダイアログを閉じる
        Navigator.of(context).pop();
        
        // 成功メッセージ
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('PDFを保存しました'),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      // エラー状態に更新
      ref.read(pdfGenerationStateProvider.notifier).setError(
        'PDF生成中にエラーが発生しました: ${e.toString()}',
      );
    }
  }
}
```

### 2.2 PDFプレビューダイアログ

```dart
// lib/features/pdf_export/presentation/dialogs/pdf_preview_dialog.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:chart_my_roots_app/features/pdf_export/application/pdf_export_controller.dart';
import 'package:printing/printing.dart';

class PdfPreviewDialog extends ConsumerWidget {
  const PdfPreviewDialog({Key? key}) : super(key: key);
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // PDF生成状態を取得
    final pdfGenerationState = ref.watch(pdfGenerationStateProvider);
    final pdfData = pdfGenerationState.pdfData;
    
    // PDFエクスポートサービスを取得
    final pdfExportService = ref.watch(pdfExportServiceProvider);
    
    return Dialog.fullscreen(
      child: Scaffold(
        appBar: AppBar(
          title: Text('PDFプレビュー'),
          leading: IconButton(
            icon: Icon(Icons.close),
            onPressed: () {
              Navigator.of(context).pop();
            },
          ),
          actions: [
            // ダウンロードボタン
            IconButton(
              icon: Icon(Icons.download),
              onPressed: pdfData != null
                  ? () async {
                      try {
                        // ファイル名の生成
                        final timestamp = DateTime.now().millisecondsSinceEpoch;
                        final fileName = 'family_tree_${timestamp}.pdf';
                        
                        // PDFをダウンロード
                        await pdfExportService.downloadPdf(pdfData, fileName);
                        
                        if (context.mounted) {
                          // 成功メッセージ
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text('PDFを保存しました'),
                              backgroundColor: Colors.green,
                            ),
                          );
                        }
                      } catch (e) {
                        if (context.mounted) {
                          // エラーメッセージ
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text('PDFの保存中にエラーが発生しました: ${e.toString()}'),
                              backgroundColor: Colors.red,
                            ),
                          );
                        }
                      }
                    }
                  : null,
              tooltip: 'ダウンロード',
            ),
            
            // 印刷ボタン
            IconButton(
              icon: Icon(Icons.print),
              onPressed: pdfData != null
                  ? () {
                      Printing.layoutPdf(
                        onLayout: (format) => pdfData,
                      );
                    }
                  : null,
              tooltip: '印刷',
            ),
          ],
        ),
        body: pdfData != null
            ? PdfPreview(
                build: (format) => pdfData,
                allowPrinting: false,
                allowSharing: false,
                canChangePageFormat: false,
                canChangeOrientation: false,
                maxPageWidth: 700,
                useActions: false,
                pdfPreviewPageDecoration: BoxDecoration(
                  color: Colors.grey.shade200,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black26,
                      blurRadius: 10,
                    ),
                  ],
                ),
              )
            : Center(
                child: Text('プレビューできるPDFがありません'),
              ),
      ),
    );
  }
}
```

### 2.3 レスポンシブ対応

PDF設定画面もモーダルダイアログとして表示されるため、基本的なレスポンシブ対応として以下の対策を行います：

```dart
// lib/features/pdf_export/presentation/dialogs/responsive_pdf_settings_dialog.dart
import 'package:flutter/material.dart';

class ResponsivePdfSettingsDialog extends StatelessWidget {
  final Widget child;
  
  const ResponsivePdfSettingsDialog({
    Key? key,
    required this.child,
  }) : super(key: key);
  
  @override
  Widget build(BuildContext context) {
    // 画面サイズを取得
    final screenWidth = MediaQuery.of(context).size.width;
    final screenHeight = MediaQuery.of(context).size.height;
    
    // 小さい画面（モバイル）の場合は全画面に近いサイズで表示
    if (screenWidth < 600) {
      return Dialog(
        insetPadding: EdgeInsets.symmetric(
          horizontal: 16,
          vertical: 24,
        ),
        child: child,
      );
    }
    
    // 大きい画面（タブレット、デスクトップ）の場合は適切なサイズに制限
    return Dialog(
      insetPadding: EdgeInsets.symmetric(
        horizontal: 40,
        vertical: 24,
      ),
      child: ConstrainedBox(
        constraints: BoxConstraints(
          maxWidth: 550,
          maxHeight: screenHeight * 0.8,
        ),
        child: child,
      ),
    );
  }
}

// 使用例
void showPdfSettingsDialog(BuildContext context) {
  showDialog(
    context: context,
    builder: (context) => ResponsivePdfSettingsDialog(
      child: PdfSettingsDialog(),
    ),
  );
}
```

## 3. 状態管理（Riverpod）

### 3.1 PDF設定の状態管理

```dart
// lib/features/pdf_export/application/pdf_settings_controller.dart
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:pdf/pdf.dart';

// PDF設定プロバイダ
final pdfSettingsProvider = StateNotifierProvider<PdfSettingsNotifier, PdfSettings>((ref) {
  // 選択中の家系図から初期タイトルを設定
  final selectedTreeAsync = ref.watch(selectedFamilyTreeStreamProvider);
  
  String initialTitle = '家系図';
  if (selectedTreeAsync.asData?.value != null) {
    initialTitle = '家系図 - ${selectedTreeAsync.asData!.value!.name}';
  }
  
  return PdfSettingsNotifier(
    PdfSettings(title: initialTitle),
  );
});

class PdfSettingsNotifier extends StateNotifier<PdfSettings> {
  PdfSettingsNotifier(PdfSettings initialState) : super(initialState);
  
  // 設定項目の更新メソッド
  void updateTitle(String title) {
    state = state.copyWith(title: title);
  }
  
  void updatePageFormat(PdfPageFormat pageFormat) {
    state = state.copyWith(pageFormat: pageFormat);
  }
  
  void updateOrientation(PdfOrientation orientation) {
    state = state.copyWith(orientation: orientation);
  }
  
  void updateShowDate(bool showDate) {
    state = state.copyWith(showDate: showDate);
  }
  
  void updateShowLegend(bool showLegend) {
    state = state.copyWith(showLegend: showLegend);
  }
  
  void updateFitToSinglePage(bool fitToSinglePage) {
    state = state.copyWith(fitToSinglePage: fitToSinglePage);
  }
  
  // 家系図データに基づいて設定をリセット
  void reset(FamilyTreeData? familyTreeData) {
    final String title = familyTreeData != null
        ? '家系図 - ${familyTreeData.name}'
        : '家系図';
    
    state = PdfSettings(title: title);
  }
}
```

### 3.2 PDF生成状態の管理

```dart
// lib/features/pdf_export/application/pdf_export_controller.dart
import 'dart:typed_data';
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:chart_my_roots_app/features/pdf_export/services/pdf_export_service.dart';
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

// PDF出力サービスプロバイダ
final pdfExportServiceProvider = Provider<PdfExportService>((ref) {
  return PdfExportService();
});

// PDF生成状態プロバイダ
final pdfGenerationStateProvider = StateNotifierProvider<PdfGenerationNotifier, PdfGenerationState>((ref) {
  return PdfGenerationNotifier();
});

// PDF生成状態
class PdfGenerationState {
  final bool isGenerating;
  final bool isComplete;
  final String? errorMessage;
  final Uint8List? pdfData;
  
  PdfGenerationState({
    this.isGenerating = false,
    this.isComplete = false,
    this.errorMessage,
    this.pdfData,
  });
  
  PdfGenerationState copyWith({
    bool? isGenerating,
    bool? isComplete,
    String? errorMessage,
    Uint8List? pdfData,
  }) {
    return PdfGenerationState(
      isGenerating: isGenerating ?? this.isGenerating,
      isComplete: isComplete ?? this.isComplete,
      errorMessage: errorMessage,
      pdfData: pdfData ?? this.pdfData,
    );
  }
}

class PdfGenerationNotifier extends StateNotifier<PdfGenerationState> {
  PdfGenerationNotifier() : super(PdfGenerationState());
  
  // PDF生成開始
  void startGenerating() {
    state = PdfGenerationState(
      isGenerating: true,
      isComplete: false,
      pdfData: null,
    );
  }
  
  // エラー設定
  void setError(String message) {
    state = PdfGenerationState(
      isGenerating: false,
      isComplete: false,
      errorMessage: message,
    );
  }
  
  // PDF生成完了
  void setPdfData(Uint8List pdfData) {
    state = PdfGenerationState(
      isGenerating: false,
      isComplete: true,
      pdfData: pdfData,
    );
  }
  
  // 状態リセット
  void reset() {
    state = PdfGenerationState();
  }
}
```

## 4. PDF生成サービス

### 4.1 PDFエクスポートサービス

```dart
// lib/features/pdf_export/services/pdf_export_service.dart
import 'dart:typed_data';
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:chart_my_roots_app/features/pdf_export/services/family_tree_pdf_generator.dart';
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';
import 'package:universal_html/html.dart' as html;
import 'dart:io' as io;
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';

class PdfExportService {
  // 日本語フォントデータの取得
  Future<Uint8List?> _loadJapaneseFont() async {
    try {
      // アセットからフォントをロード
      return await rootBundle.load('assets/fonts/NotoSansJP-Regular.ttf')
          .then((data) => data.buffer.asUint8List());
    } catch (e) {
      print('Failed to load Japanese font: $e');
      return null; // フォントが見つからなければnullを返す
    }
  }

  // PDFを生成
  Future<Uint8List> generatePdf({
    required FamilyTreeData familyTreeData,
    required PdfSettings settings,
  }) async {
    // 日本語フォントの読み込み
    final japaneseFontData = await _loadJapaneseFont();
    
    // PDF生成器の作成
    final generator = FamilyTreePdfGenerator(
      japaneseFontData: japaneseFontData,
    );
    
    // PDFを生成
    return await generator.generatePdf(
      familyTreeData: familyTreeData,
      settings: settings,
    );
  }

  // PDFをダウンロード（Web）または共有（モバイル）
  Future<void> downloadPdf(Uint8List pdfData, String fileName) async {
    if (kIsWeb) {
      // Webの場合はダウンロード
      final blob = html.Blob([pdfData], 'application/pdf');
      final url = html.Url.createObjectUrlFromBlob(blob);
      
      final anchor = html.AnchorElement(href: url)
        ..setAttribute('download', fileName)
        ..click();
      
      html.Url.revokeObjectUrl(url);
    } else {
      // モバイル/デスクトップの場合は一時ファイルに保存して共有
      final directory = await getTemporaryDirectory();
      final path = '${directory.path}/$fileName';
      final file = io.File(path);
      await file.writeAsBytes(pdfData);
      
      await Share.shareXFiles(
        [XFile(path)],
        text: '家系図PDF',
        subject: fileName,
      );
    }
  }
}
```

## 5. 画面遷移と操作フロー

### 5.1 PDF設定・生成フロー

1. メイン画面の「PDF出力」ボタンをクリック
2. 選択中の家系図に基づいてPDF設定を初期化
3. PDF設定ダイアログを表示
4. ユーザーが各種設定（用紙サイズ、向き、タイトルなど）を選択
5. 「PDFを生成」ボタンをクリック
6. PDF生成処理を開始（保存中状態に設定）
7. PDFデータの生成
8. 生成成功時：
   1. ファイル名を生成
   2. PDFをダウンロード（Web）または共有（モバイル）
   3. ダイアログを閉じ、成功メッセージを表示
9. 生成失敗時：エラーメッセージを表示

### 5.2 PDFプレビューフロー

1. PDF設定ダイアログで「プレビュー」ボタンをクリック
2. PDF生成処理を開始（保存中状態に設定）
3. PDFデータの生成
4. 生成成功時：
   1. 設定ダイアログを閉じる
   2. プレビューダイアログを表示
   3. PDFプレビューを表示
5. 生成失敗時：エラーメッセージを表示

### 5.3 PDFダウンロードフロー（プレビューから）

1. プレビューダイアログの「ダウンロード」ボタンをクリック
2. ファイル名を生成
3. PDFをダウンロード（Web）または共有（モバイル）
4. 成功時：成功メッセージを表示
5. 失敗時：エラーメッセージを表示

## 6. エラーハンドリング

### 6.1 PDF生成時のエラー処理

```dart
// lib/features/pdf_export/utils/pdf_error_handler.dart
import 'package:flutter/material.dart';

class PdfErrorHandler {
  // エラーメッセージの整形
  static String formatErrorMessage(dynamic error) {
    String baseMessage = 'PDF生成中にエラーが発生しました';
    
    if (error is Exception) {
      // メモリ不足エラーの場合
      if (error.toString().contains('OutOfMemoryError') ||
          error.toString().contains('memory')) {
        return '$baseMessage: メモリ不足です。複数ページに分割するか、より小さなサイズで出力してください。';
      }
      
      // フォント関連エラーの場合
      if (error.toString().contains('font') ||
          error.toString().contains('Font')) {
        return '$baseMessage: フォントの読み込みに失敗しました。';
      }
      
      // その他の例外
      return '$baseMessage: ${error.toString()}';
    }
    
    // 一般的なエラー
    return '$baseMessage: ${error.toString()}';
  }
  
  // エラー表示スナックバー
  static void showErrorSnackBar(BuildContext context, String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }
  
  // 成功表示スナックバー
  static void showSuccessSnackBar(BuildContext context, String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }
}
```

### 6.2 メモリ不足対策

```dart
// lib/features/pdf_export/utils/pdf_memory_optimization.dart
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:pdf/pdf.dart';

class PdfMemoryOptimization {
  // 家系図サイズに基づいた最適な設定を取得
  static PdfSettings getOptimizedSettings(FamilyTreeData familyTree, PdfSettings baseSettings) {
    // 人物数に基づいて設定を調整
    final personCount = familyTree.persons.length;
    
    if (personCount > 100) {
      // 大規模家系図の場合の最適化
      return baseSettings.copyWith(
        fitToSinglePage: false, // 複数ページを推奨
      );
    } else if (personCount > 50) {
      // 中規模家系図の場合の最適化
      return baseSettings.copyWith(
        // A3サイズを推奨（ただし、ユーザー設定を尊重）
      );
    }
    
    // 小規模家系図の場合はそのまま
    return baseSettings;
  }
  
  // PDFレンダリング時のメモリ使用量を見積もる
  static bool isLikelyToExceedMemoryLimit(FamilyTreeData familyTree, PdfSettings settings) {
    // 簡易的なメモリ使用量見積もりロジック
    final personCount = familyTree.persons.length;
    final relationshipCount = familyTree.relationships.length;
    
    // 以下は簡易的な計算式の例
    final estimatedMemoryMB = (personCount * 0.5) + (relationshipCount * 0.1) + 10;
    
    // 1ページに収める場合は追加メモリが必要
    if (settings.fitToSinglePage && personCount > 50) {
      return estimatedMemoryMB > 100; // 100MBを超える場合は警告
    }
    
    return estimatedMemoryMB > 200; // 200MBを超える場合は警告
  }
}
```

## 7. アクセシビリティ

### 7.1 アクセシビリティ対応

```dart
// lib/features/pdf_export/presentation/accessibility/pdf_settings_accessibility.dart
import 'package:flutter/material.dart';

class PdfSettingsAccessibility {
  // セマンティックラベルの生成
  static String generatePageFormatLabel(String formatName, String dimensions) {
    return '用紙サイズ: $formatName、$dimensions';
  }
  
  static String generateOrientationLabel(bool isPortrait) {
    return '向き: ${isPortrait ? "縦向き" : "横向き"}';
  }
  
  // フォーカス順序の管理
  static List<FocusNode> createFormFocusNodes() {
    return [
      FocusNode(), // タイトル
      FocusNode(), // A4 ラジオボタン
      FocusNode(), // A3 ラジオボタン
      FocusNode(), // レターサイズ ラジオボタン
      FocusNode(), // 縦向き ラジオボタン
      FocusNode(), // 横向き ラジオボタン
      FocusNode(), // 日付表示 チェックボックス
      FocusNode(), // 凡例表示 チェックボックス
      FocusNode(), // 1ページに収める チェックボックス
    ];
  }
  
  // PDF設定ダイアログにアクセシビリティ機能を適用
  static Widget addAccessibility(Widget dialog, List<FocusNode> focusNodes) {
    return Semantics(
      label: 'PDF出力設定ダイアログ',
      hint: 'この画面ではPDF出力の設定ができます',
      child: dialog,
    );
  }
}
```

### 7.2 キーボード操作の対応

```dart
// キーボード操作への対応
void _handleKeyboardShortcuts(RawKeyEvent event, BuildContext context, WidgetRef ref) {
  if (event is RawKeyDownEvent) {
    if (event.isControlPressed && event.logicalKey == LogicalKeyboardKey.keyP) {
      // Ctrl+P でプレビュー
      _generatePdfForPreview(context, ref);
    } else if (event.isControlPressed && event.logicalKey == LogicalKeyboardKey.keyS) {
      // Ctrl+S で生成・保存
      _generateAndDownloadPdf(context, ref);
    } else if (event.logicalKey == LogicalKeyboardKey.escape) {
      // ESC でキャンセル
      Navigator.of(context).pop();
    }
  }
}
```

## 8. パフォーマンス最適化

### 8.1 PDF生成の最適化

```dart
// lib/features/pdf_export/utils/pdf_generation_optimization.dart
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:flutter/foundation.dart';

class PdfGenerationOptimization {
  // バックグラウンドスレッドでPDFを生成
  static Future<Uint8List> generatePdfInBackground({
    required FamilyTreeData familyTreeData,
    required PdfSettings settings,
    required Future<Uint8List> Function(FamilyTreeData, PdfSettings) generator,
  }) async {
    // computeメソッドを使用して別スレッドで重い処理を実行
    return compute(
      _pdfGenerationIsolate,
      {
        'familyTreeData': familyTreeData,
        'settings': settings,
        'generatorFunction': generator,
      },
    );
  }
  
  // Isolateで実行するための静的メソッド
  static Future<Uint8List> _pdfGenerationIsolate(Map<String, dynamic> params) async {
    final familyTreeData = params['familyTreeData'] as FamilyTreeData;
    final settings = params['settings'] as PdfSettings;
    final generator = params['generatorFunction'] as Future<Uint8List> Function(FamilyTreeData, PdfSettings);
    
    return await generator(familyTreeData, settings);
  }
}
```

### 8.2 大規模家系図の対応

```dart
// lib/features/pdf_export/utils/large_tree_handler.dart
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';

class LargeTreeHandler {
  // 家系図を複数のグループに分割
  static List<FamilyTreeData> splitLargeTree(FamilyTreeData familyTree) {
    // 世代ごとに分割するロジック
    // （実装省略）
    return [familyTree]; // 未実装の場合は元の家系図をそのまま返す
  }
  
  // 大規模家系図の警告表示が必要かどうか
  static bool shouldShowLargeTreeWarning(FamilyTreeData familyTree) {
    final personCount = familyTree.persons.length;
    return personCount > 100;
  }
  
  // 大規模家系図の警告メッセージ
  static String getLargeTreeWarningMessage(FamilyTreeData familyTree, PdfSettings settings) {
    final personCount = familyTree.persons.length;
    
    if (settings.fitToSinglePage && personCount > 100) {
      return '大規模な家系図（${personCount}人）を1ページに収めると、各ノードが非常に小さくなり読みにくくなる可能性があります。複数ページへの分割をお勧めします。';
    }
    
    if (personCount > 150) {
      return '大規模な家系図（${personCount}人）はPDFの生成に時間がかかる場合があります。しばらくお待ちください。';
    }
    
    return '';
  }
}
```

## 9. テスト計画

### 9.1 PDF設定ダイアログのテスト

```dart
// test/features/pdf_export/presentation/dialogs/pdf_settings_dialog_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:chart_my_roots_app/features/pdf_export/presentation/dialogs/pdf_settings_dialog.dart';
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:pdf/pdf.dart';
import 'package:mocktail/mocktail.dart';

// モッククラス
class MockPdfExportService extends Mock {}

void main() {
  testWidgets('PdfSettingsDialog displays title field with initial value', (WidgetTester tester) async {
    // モックデータの設定
    final initialSettings = PdfSettings(
      title: 'Test Title',
    );
    
    final overrides = [
      pdfSettingsProvider.overrideWith((ref) => PdfSettingsNotifier(initialSettings)),
    ];
    
    // ダイアログをビルド
    await tester.pumpWidget(
      ProviderScope(
        overrides: overrides,
        child: MaterialApp(
          home: Scaffold(
            body: Builder(
              builder: (context) => ElevatedButton(
                onPressed: () {
                  showDialog(
                    context: context,
                    builder: (_) => PdfSettingsDialog(),
                  );
                },
                child: Text('Open Dialog'),
              ),
            ),
          ),
        ),
      ),
    );
    
    // ダイアログを開く
    await tester.tap(find.text('Open Dialog'));
    await tester.pumpAndSettle();
    
    // タイトルフィールドの初期値を確認
    expect(find.text('Test Title'), findsOneWidget);
    
    // 他のテスト（省略）
  });
  
  testWidgets('PdfSettingsDialog updates state when radio buttons are clicked', (WidgetTester tester) async {
    // モックデータの設定
    final initialSettings = PdfSettings(
      title: 'Test Title',
      pageFormat: PdfPageFormat.a4,
      orientation: PdfOrientation.portrait,
    );
    
    // Stateを監視できるようにするための変数
    late PdfSettings capturedSettings;
    
    final overrides = [
      pdfSettingsProvider.overrideWith((ref) {
        final notifier = PdfSettingsNotifier(initialSettings);
        capturedSettings = initialSettings;
        
        // リスナーを追加
        ref.listenSelf((previous, next) {
          capturedSettings = next;
        });
        
        return notifier;
      }),
    ];
    
    // ダイアログをビルド
    await tester.pumpWidget(
      ProviderScope(
        overrides: overrides,
        child: MaterialApp(
          home: Scaffold(
            body: Builder(
              builder: (context) => ElevatedButton(
                onPressed: () {
                  showDialog(
                    context: context,
                    builder: (_) => PdfSettingsDialog(),
                  );
                },
                child: Text('Open Dialog'),
              ),
            ),
          ),
        ),
      ),
    );
    
    // ダイアログを開く
    await tester.tap(find.text('Open Dialog'));
    await tester.pumpAndSettle();
    
    // A3ラジオボタンをタップ
    await tester.tap(find.text('A3'));
    await tester.pumpAndSettle();
    
    // 設定が更新されることを確認
    expect(capturedSettings.pageFormat, equals(PdfPageFormat.a3));
    
    // 横向きラジオボタンをタップ
    await tester.tap(find.text('横向き'));
    await tester.pumpAndSettle();
    
    // 設定が更新されることを確認
    expect(capturedSettings.orientation, equals(PdfOrientation.landscape));
  });
  
  // 他のテストケース（省略）
}
```

### 9.2 PDF生成サービスのテスト

```dart
// test/features/pdf_export/services/pdf_export_service_test.dart
import 'dart:typed_data';
import 'package:chart_my_roots_app/features/pdf_export/models/pdf_settings.dart';
import 'package:chart_my_roots_app/features/pdf_export/services/pdf_export_service.dart';
import 'package:chart_my_roots_app/models/family_tree_data.dart';
import 'package:chart_my_roots_app/models/person.dart';
import 'package:chart_my_roots_app/models/relationship.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';
import 'package:pdf/pdf.dart';

class MockFamilyTreePdfGenerator extends Mock {}

void main() {
  late PdfExportService service;
  
  setUp(() {
    service = PdfExportService();
  });
  
  group('PdfExportService Tests', () {
    test('generatePdf creates PDF data with minimum viable family tree', () async {
      // 最小限の家系図データを作成
      final familyTree = FamilyTreeData(
        id: 'test-tree',
        name: 'Test Tree',
        persons: [
          Person(
            id: 'p1',
            name: 'Test Person',
          ),
        ],
        relationships: [],
        lastModified: DateTime.now(),
      );
      
      // 基本的な設定
      final settings = PdfSettings(
        title: 'Test PDF',
        pageFormat: PdfPageFormat.a4,
        orientation: PdfOrientation.portrait,
        showDate: true,
        showLegend: true,
        fitToSinglePage: true,
      );
      
      // PDFを生成
      final pdfData = await service.generatePdf(
        familyTreeData: familyTree,
        settings: settings,
      );
      
      // 結果の検証
      expect(pdfData, isA<Uint8List>());
      expect(pdfData.isNotEmpty, true);
      
      // PDF形式のヘッダーチェック
      expect(String.fromCharCodes(pdfData.sublist(0, 4)), '%PDF');
    });
    
    // 他のテストケース（省略）
  });
}
```

### 9.3 統合テスト

```dart
// integration_test/pdf_export_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:chart_my_roots_app/main.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();
  
  testWidgets('Complete PDF export flow', (WidgetTester tester) async {
    // アプリを起動
    await tester.pumpWidget(ChartMyRootsApp());
    
    // メイン画面に移動
    // ...
    
    // PDF出力ボタンをタップ
    await tester.tap(find.byIcon(Icons.picture_as_pdf));
    await tester.pumpAndSettle();
    
    // 設定ダイアログが表示されることを確認
    expect(find.text('PDF出力設定'), findsOneWidget);
    
    // タイトルを変更
    await tester.enterText(find.byType(TextFormField).first, 'テストPDF');
    
    // A3サイズを選択
    await tester.tap(find.text('A3'));
    await tester.pumpAndSettle();
    
    // 横向きを選択
    await tester.tap(find.text('横向き'));
    await tester.pumpAndSettle();
    
    // プレビューボタンをタップ
    await tester.tap(find.text('プレビュー'));
    await tester.pumpAndSettle();
    
    // 生成中表示が出ることを確認
    expect(find.text('PDFを生成中...'), findsOneWidget);
    
    // 生成完了を待つ
    // ここではテストの都合上、固定時間待機
    await Future.delayed(Duration(seconds: 5));
    await tester.pumpAndSettle();
    
    // プレビューダイアログが表示されることを確認
    expect(find.text('PDFプレビュー'), findsOneWidget);
    
    // ダウンロードボタンをタップ
    await tester.tap(find.byIcon(Icons.download));
    await tester.pumpAndSettle();
    
    // 成功メッセージを確認
    expect(find.text('PDFを保存しました'), findsOneWidget);
  });
}
```

## 10. まとめ

PDF設定画面は、家系図をPDF形式で出力するための設定を行う重要な機能です。本設計では以下のポイントを重視しています：

1. **柔軟な出力設定**
   - 用紙サイズ（A4、A3、レターサイズ）の選択
   - 向き（縦向き、横向き）の選択
   - タイトルのカスタマイズ
   - 表示オプション（日付、凡例、ページ収め）

2. **直感的なプレビュー**
   - 設定に応じた簡易プレビュー表示
   - 生成前のイメージ確認
   - 専用プレビューダイアログでの詳細確認

3. **高品質なPDF生成**
   - 日本語フォント対応
   - 印刷に適した解像度設定
   - 大規模家系図への対応

4. **プラットフォーム対応**
   - Webブラウザでのダウンロード機能
   - モバイルデバイスでの共有機能
   - 印刷サポート

5. **パフォーマンス最適化**
   - バックグラウンドスレッドでの生成処理
   - メモリ使用量の最適化
   - 大規模データの分割処理

これらの設計により、ユーザーは家系図を美しく整ったPDFとして出力し、印刷や共有に活用できます。特に家系図のような視覚的なデータを紙媒体として残したいユーザーにとって、重要な機能となります。
