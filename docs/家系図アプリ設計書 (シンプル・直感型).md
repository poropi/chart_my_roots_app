# **家系図アプリ設計書 (シンプル・直感型)**

## **1\. アプリケーションの要件定義**

### **1.1. アプリの目的**

ユーザーが直感的かつ手軽に家系図を作成、閲覧、管理できるWebアプリケーションを提供する。主な操作はPCブラウザで行い、スマートフォンでも快適に利用できるようレスポンシブ対応する。

### **1.2. ターゲットユーザー**

* PCブラウザで家系図を作成・管理したいユーザー  
* スマートフォンで手軽に家系図を閲覧・簡単な編集をしたいユーザー  
* デジタルで家族の記録を残したいが、複雑な操作は避けたいユーザー

### **1.3. 主要機能リスト**

1. **人物情報の管理機能**  
   * 記録項目: 氏名（必須）、旧姓、生年月日、没年月日、性別、続柄（関係性設定時に自動または手動で設定）、メモ（簡単な備考）  
   * 操作: 人物の追加、編集、削除  
2. **家系図表示機能**  
   * 表示形式: 縦型ツリー（上から下）、横型ツリー（左右）の選択・切り替え  
   * インタラクション:  
     * スクロール表示（全体表示のため）  
     * 拡大・縮小表示（マウスホイール、ピンチ操作、ボタンなど）  
     * 人物ノードのタップ/クリックによる選択、ハイライト  
     * 選択した人物を中心とした表示への切り替え（フォーカス機能）  
3. **データ永続化機能**  
   * メインストレージ: Firebase Firestore (ユーザーアカウントごとのデータ管理)  
   * エクスポート: 家系図データをJSONファイルとしてダウンロード  
   * インポート: JSONファイルから家系図データをアップロードして復元  
4. **PDF出力機能**  
   * 形式: PDFファイル  
   * レイアウト: A4用紙1枚に収まるように自動調整（人数が多い場合の調整方法も考慮）  
5. **レスポンシブデザイン**  
   * PCブラウザ、スマートフォンブラウザの各画面サイズに最適化された表示

### **1.4. 非機能要件**

* **UI/UX:** 温かみのある手書き風デザイン。シンプルで直感的な操作性。  
* **パフォーマンス:** 大量の人物データでも表示が遅くならないよう配慮。  
* **セキュリティ:** Firestoreのセキュリティルールを適切に設定し、ユーザーデータ保護。  
* **保守性:** コードの可読性、コンポーネントの再利用性を高める。

### **1.5. 技術的制約・前提条件**

* 開発フレームワーク: Flutter (Web)  
* データベース: Firebase Firestore  
* ターゲットブラウザ: モダンブラウザ（Chrome, Firefox, Safari, Edgeの最新版）

## **2\. アーキテクチャ選定**

Flutter Webでの開発、Firestoreとの連携、そして「シンプルさ」を考慮すると、以下のアーキテクチャが候補となります。

* **Riverpod:**  
  * Flutterコミュニティで広く採用されており、Flutter Webとの相性も良い。  
  * 状態管理とDI（依存性注入）をシンプルに扱える。  
  * テスト容易性も高い。  
  * **推奨:** 本プロジェクトの規模と要件に合致すると考えられる。  
* **BLoC/Cubit:**  
  * UIとビジネスロジックの分離に優れている。  
  * CubitはBLoCよりもシンプルに記述可能。  
  * Riverpodと組み合わせて使用することも可能。

**選定方針:** まずは **Riverpod** を主軸に検討し、必要に応じてCubitのようなよりシンプルなビジネスロジックコンポーネントを組み合わせる構成が良いでしょう。状態の変更が複雑な家系図描画部分では、Streamベースの処理が活きる可能性があります。

## **3\. UI/UXデザイン**

### **3.1. デザイン原則**

* **カスタムデザイン:** 「温かみのある手書き風」をテーマとし、アプリ独自のブランドイメージを構築する。  
  * フォント: 手書き風フォント、または温かみのある丸ゴシック系フォントを選定。  
  * 配色: アースカラーやパステルカラーなど、温もりを感じさせる配色。  
  * アイコン: 手書き風のカスタムアイコン、またはテーマに合うシンプルなアイコンセット。  
  * 要素の形状: 角丸や少し不揃いな線を意識し、手作り感を演出。  
* **シンプル & インテュイティブ:** ユーザーが操作に迷わないよう、機能は絞り込み、明確な導線を設計する。

### **3.2. レスポンシブデザイン**

* MediaQuery や LayoutBuilder を活用し、PCとスマートフォンで最適なレイアウトを提供する。  
* PC: マウス操作を前提とした広い画面での一覧性、操作性を重視。サイドパネルやモーダルウィンドウを効果的に使用。  
* スマートフォン: タッチ操作を前提とし、主要機能をアクセスしやすい位置に配置。情報の表示量を調整。

### **3.3. ナビゲーション**

* **GoRouter:** Flutter WebでのURLベースナビゲーションを実現。  
* 基本的にはシングルページアプリケーション（SPA）のような操作感を目指し、家系図表示画面をメインとする。人物編集などはモーダルダイアログや画面内パネルで対応。

### **3.4. ユーザーフィードバック**

* 操作（保存、追加、削除、エクスポートなど）に対する視覚的なフィードバック（ローディング表示、成功・エラーメッセージ）を明確に表示。  
* 家系図操作（拡大縮小、スクロール、人物選択）もスムーズで直感的に行えるようにする。

## **4\. 状態管理 (State Management)**

* **Riverpod** を使用。  
* 管理する主な状態:  
  * 家系図データ（人物リスト、関係性リスト）  
  * 現在の表示設定（縦型/横型、ズームレベル、表示位置）  
  * 選択中の人物情報  
  * 編集中の人物情報  
  * UIの状態（ローディング中、エラー発生など）  
* Firestoreとのデータ同期もRiverpodのProviderを通じて行う。

## **5\. ナビゲーションとルーティング**

* **GoRouter** を採用。  
* 主なルート:  
  * /: 家系図表示・編集画面 (メイン画面)  
  * /settings: （もし設定画面が必要な場合）  
  * /auth: （もし認証機能を追加する場合）  
* URLによって特定の家系図や人物に直接アクセスできるような設計も将来的には検討可能（今回はシンプルさを優先）。

## **6\. データ永続化と通信**

### **6.1. Firebase Firestore**

* **データモデル案:**  
  * users/{userId}/familyTrees/{treeId}/persons/{personId}: 各人物の情報  
    * name: String (氏名)  
    * maidenName: String (旧姓, nullable)  
    * birthDate: Timestamp (生年月日, nullable)  
    * deathDate: Timestamp (没年月日, nullable)  
    * gender: String ('male', 'female', 'other', nullable)  
    * memo: String (メモ, nullable)  
    * x: double (家系図上のX座標 \- レイアウトエンジンが計算)  
    * y: double (家系図上のY座標 \- レイアウトエンジンが計算)  
  * users/{userId}/familyTrees/{treeId}/relationships/{relationshipId}: 人物間の関係性  
    * fromPersonId: String (関連元の人物ID)  
    * toPersonId: String (関連先の人物ID)  
    * type: String ('parent\_child', 'spouse')  
  * **備考:**  
    * userId は Firebase Authentication を利用する場合のユーザーID。利用しない場合は、ローカルで生成したIDや、単一ユーザー前提の固定IDなど、運用に合わせて検討。  
    * 続柄は relationships から導出するか、persons ドキュメント内に冗長的に持たせることも可能（表示パフォーマンスを考慮）。  
    * 家系図のレイアウト情報は、クライアント側で計算し、表示の高速化のためにFirestoreに保存することも検討できますが、まずはクライアント側での動的計算を基本とします。  
* **セキュリティルール:**  
  * ユーザーが自身のデータのみ読み書きできるように設定。  
  * 例: allow read, write: if request.auth.uid \== userId;

### **6.2. データのエクスポート/インポート**

* **ファイル形式:** JSON  
  * エクスポート: 現在表示している家系図の全人物情報と関係性情報をJSON形式で出力。  
  * インポート: アップロードされたJSONファイルを解析し、Firestoreにデータを書き込む。重複チェックやマージ戦略はシンプルに（例: 新規として追加、またはIDが一致すれば上書き）。  
* **注意点:** FirestoreのTimestamp型はJSONではISO8601形式の文字列や数値（エポック秒）としてシリアライズ/デシリアライズする必要がある。

### **6.3. クラウドストレージへのバックアップ (iCloud/Google Drive)**

* Flutter Webから直接ユーザーのiCloud/Google Driveにシームレスにバックアップする機能は、OSレベルの権限やAPI連携が必要となり、シンプルさを目指す本アプリでは実装の複雑度が高くなります。  
* **推奨案:**  
  * Firestoreへの自動保存をメインとし、ユーザー自身による**手動エクスポート（JSON）を推奨**する。ダウンロードしたJSONファイルをユーザーが自身のクラウドストレージに保存する運用を案内する。  
  * もし将来的にGoogleアカウント認証を導入する場合、Google Drive APIを利用してユーザーの同意のもとバックアップ機能を実装する選択肢はありますが、初期リリースでは見送りが妥当です。

## **7\. プロジェクト構成**

アーキテクチャ（例: Riverpod）と機能ベースの構成を組み合わせる。

lib/  
├── main.dart                     \# アプリケーションのエントリポイント  
├── app.dart                      \# MaterialApp/CupertinoAppの定義、テーマ設定  
|  
├── features/                     \# 機能ごとのモジュール  
│   └── family\_tree/  
│       ├── application/          \# Riverpod Provider, ビジネスロジック (UseCase的なもの)  
│       │   ├── tree\_controller.dart  
│       │   └── person\_editor\_controller.dart  
│       ├── data/                 \# データ層  
│       │   ├── models/           \# Person, Relationshipモデル (json\_serializable)  
│       │   │   ├── person\_model.dart  
│       │   │   └── relationship\_model.dart  
│       │   ├── repositories/     \# データ操作の抽象インターフェース  
│       │   │   └── family\_tree\_repository.dart  
│       │   └── datasources/      \# Firestoreとの具体的な通信  
│       │       └── firestore\_datasource.dart  
│       ├── presentation/         \# UI層 (ウィジェット、スクリーン)  
│       │   ├── screens/  
│       │   │   └── family\_tree\_screen.dart  
│       │   ├── widgets/          \# 共通UI部品 (Personノード, 編集フォームなど)  
│       │   │   ├── person\_node\_widget.dart  
│       │   │   └── person\_form\_widget.dart  
│       │   └── layout/           \# 家系図描画ロジック、レイアウトアルゴリズム  
│       │       └── tree\_layout\_delegate.dart  
│       └── utils/                \# 当該機能固有のユーティリティ  
|  
├── core/                         \# アプリ全体で利用するコア機能  
│   ├── theme/                    \# アプリのテーマ設定 (フォント、色など)  
│   │   └── app\_theme.dart  
│   ├── router/                   \# GoRouterの設定  
│   │   └── app\_router.dart  
│   ├── constants/                \# 定数  
│   ├── utils/                    \# 汎用ユーティリティ  
│   └── widgets/                  \# アプリ全体で共通のウィジェット (カスタムボタンなど)  
|  
└── services/                     \# 外部サービス (PDF生成など)  
    └── pdf\_exporter.dart

## **8\. テスト**

* **ユニットテスト:**  
  * モデルクラスのシリアライズ/デシリアライズ  
  * Riverpod Providerのロジック  
  * レイアウトアルゴリズムの計算ロジック  
* **ウィジェットテスト:**  
  * Personノードの表示とインタラクション  
  * 人物情報編集フォームの動作  
* **インテグレーションテスト (検討):**  
  * Firestoreとのデータ読み書きフロー（モックFirestoreを利用）  
  * PDF生成処理

## **9\. その他考慮事項**

### **9.1. 家系図描画**

* **ライブラリ/手法:**  
  * graphview **パッケージ:** Flutterでグラフ構造を描画するための一般的なライブラリ。カスタマイズ性によっては手書き風の表現も可能か検討。  
  * force\_directed\_graphview **パッケージ:** 力学モデルに基づいたレイアウト。有機的な配置が手書き風と合う可能性。  
  * CustomPaint **と** Canvas**:** 最も柔軟性が高いが、レイアウトアルゴリズム（例: Reingold-Tilford, Sugiyama法など）や描画ロジックを自前で実装する必要があり、開発コストが高い。「手書き風」の線を引く、ノードを不均一に配置するなど、細かな表現が可能。  
  * **SVGの利用:** 手書き風のノード形状や接続線をSVGで作成し、Flutter上で表示・操作することも考えられます。  
* **レイアウトアルゴリズム:** シンプルなツリー構造であれば、比較的簡単なアルゴリズムで実装可能。親子関係、兄弟関係を考慮してノードを配置する。  
* **手書き風の実現:**  
  * 線の揺らぎ: Path を描画する際に、直線ではなく少し揺らいだ線にする。  
  * ノード形状: 完全な円や四角ではなく、少し崩れた形状にする。  
  * フォント: 手書き風フォントの利用。

### **9.2. PDF出力 (A4用紙1枚)**

* **ライブラリ:** pdf パッケージと printing パッケージ。  
* **レイアウト調整:**  
  * 家系図全体のサイズを取得し、A4の縦横比に合わせてスケーリング。  
  * 人物の数が多い場合:  
    * フォントサイズ、ノードサイズ、間隔を縮小して1枚に収める（可読性の限界を考慮）。  
    * ユーザーに出力範囲を選択させる機能（高度な機能）。  
    * 「1枚に収める」が最優先であれば、ある程度の情報量の省略やデフォルメも許容するか検討。  
  * 縦型/横型レイアウトそれぞれで最適化されたPDF出力。

### **9.3. 関係性の定義UI**

* PC (マウス操作):  
  * 人物ノードを右クリック → 「親を追加」「子を追加」「配偶者を追加」メニュー  
  * 特定の人物を選択後、ツールバーやサイドパネルから関係性を追加するボタンを表示  
  * ドラッグ＆ドロップで人物間を線で結び、関係性の種類を選択する（直感的だが実装難易度はやや高め）  
* スマートフォン (タッチ操作):  
  * 人物ノードを長押し → コンテキストメニュー  
  * 選択した人物の詳細画面から関係性を追加

### **9.4. エクスポート/インポートのファイル形式**

* **JSON形式を推奨。** 構造が明確で、Dart/Flutterでの扱いや、将来的な拡張性も考慮するとバランスが良い。  
* 家系図専用形式のGEDCOM (.ged) も存在しますが、パーサーの実装が必要となり、シンプルさを目指す今回のアプリではオーバースペックになる可能性があります。

### **9.5. 「手書き風」デザインの具体的なイメージ**

* **フォント:** 例えば「Klee One」「Yusei Magic」「M PLUS Rounded 1c」の細いウェイトなど、柔らかさや手書き感のある日本語フォント。  
* **線:** 完全な直線ではなく、Path.quadraticBezierTo などを使って少しだけカーブさせたり、線の太さに僅かな強弱をつけたりする。  
* **ノード:** CustomPainter で、少し歪んだ円や四角形を描画。背景に薄いテクスチャ（和紙のような質感など）を敷くのも効果的。  
* **色:** 彩度を抑えた暖色系、または自然を想起させるアースカラー。アクセントカラーも落ち着いた色味で。

この設計書案はいかがでしょうか？  
特に、「手書き風デザインの具体的なイメージ」「人物間の関係性の設定方法」について、さらに具体的なアイデアやご希望があれば、ぜひお聞かせください。  
また、Firestoreのデータ構造やエクスポート/インポート形式についても、この内容で進めて問題ないかご確認ください。  
これらの詳細を詰めていくことで、より明確な開発の指針が見えてくるかと思います。