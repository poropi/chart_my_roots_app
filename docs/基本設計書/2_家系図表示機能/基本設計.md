# 家系図表示機能 基本設計書

## 1. 概要

ユーザーが登録した人物と関係性データを元に、視覚的な家系図を表示する機能です。直感的な操作で家系図を閲覧・操作できるようにします。

## 2. 機能要件

### 2.1 表示形式

1. **縦型ツリー（上から下）**
   - 世代を上から下へ表示
   - 祖先が上、子孫が下に配置される
   - 兄弟は左右に並べて表示

2. **横型ツリー（左右）**
   - 世代を左から右へ表示
   - 祖先が左、子孫が右に配置される
   - 兄弟は上下に並べて表示

3. **表示切り替え**
   - 縦型/横型の表示形式をボタン一つで切り替え可能
   - 切り替え時にアニメーションで自然な遷移を提供

### 2.2 インタラクション機能

1. **スクロール表示**
   - マウスドラッグまたはタッチスワイプで家系図全体をスクロール
   - 惰性スクロール（フリック操作）にも対応

2. **拡大・縮小表示**
   - マウスホイール：上下で拡大縮小
   - タッチデバイス：ピンチイン・ピンチアウトで拡大縮小
   - 拡大縮小ボタン：クリック/タップで段階的に拡大縮小
   - 拡大縮小の範囲を設定（最小/最大ズームレベル）

3. **人物ノードの選択**
   - タップ/クリックで人物ノードを選択
   - 選択された人物ノードはハイライト表示
   - 選択時に人物の詳細情報をサイドパネルまたはモーダルで表示

4. **フォーカス機能**
   - 選択した人物を中心とした表示に切り替え
   - 「○○を中心に表示」ボタンをクリック/タップで実行
   - アニメーションで自然に視点移動

### 2.3 視覚表現

1. **人物ノード**
   - 人物の基本情報（氏名、生没年）を表示
   - 性別による視覚的区別（色や形の違い）
   - 選択状態の視覚的表現

2. **関係線**
   - 親子関係：縦/横の実線
   - 配偶者関係：横/縦の波線や二重線
   - 養子縁組：点線などで区別（オプション）

3. **世代表示**
   - 世代ごとに区切り線や背景色を変える（オプション）
   - 世代番号や年代を表示（オプション）

## 3. 技術設計

### 3.1 レイアウトアルゴリズム

1. **階層レイアウト計算**
   - 親子関係から階層（世代）を自動計算
   - 同一世代内で兄弟を適切に配置
   - 配偶者を隣接して配置

2. **ノードの位置計算**
   - 各ノードの座標(x, y)を計算
   - ノード間の適切な間隔を確保
   - ノードの重なりを防止

3. **自動レイアウト最適化**
   - ツリーの全体バランスを考慮
   - 交差する線を最小化
   - 表示領域を効率的に使用

### 3.2 実装アプローチ

1. **カスタムペインター**
   - `CustomPainter`を使用して関係線を描画
   - 高パフォーマンスな描画処理

2. **レイアウトエンジン**
   - 独自のレイアウトアルゴリズムを実装
   - または既存のグラフ描画ライブラリを活用（graphview等）

3. **インタラクティブキャンバス**
   - GestureDetectorと組み合わせた操作性
   - TransformWidgetによる拡大縮小・移動

## 4. 画面設計

### 4.1 メイン画面レイアウト

```
+------------------------------------------+
|  [操作バー] 縦表示 | 横表示 | 拡大 | 縮小  |
+------------------------------------------+
|                                          |
|              家系図表示領域              |
|                                          |
|   [人物ノード]   [人物ノード]            |
|       |             |                    |
|   [人物ノード]---[人物ノード]            |
|       |                                  |
|   [人物ノード]                           |
|                                          |
+------------------------------------------+
|  [ステータスバー] ズーム率: 100%         |
+------------------------------------------+
```

### 4.2 人物ノードデザイン

```
+----------------------+
|      [写真/アイコン]  |
|                      |
|  山田 太郎 (旧姓: -) |
|  1960年4月1日 〜     |
+----------------------+
```

## 5. 状態管理（Riverpod）

### 5.1 表示設定の状態管理

```dart
// 表示方向（縦/横）
final displayOrientationProvider = StateProvider<DisplayOrientation>((ref) {
  return DisplayOrientation.vertical;
});

// ズームレベル
final zoomLevelProvider = StateProvider<double>((ref) {
  return 1.0; // 初期値: 100%
});

// 表示位置（スクロール位置）
final viewPositionProvider = StateProvider<Offset>((ref) {
  return Offset.zero;
});

// 選択中の人物
final selectedPersonProvider = StateProvider<Person?>((ref) {
  return null;
});

enum DisplayOrientation {
  vertical, // 縦型（上から下）
  horizontal, // 横型（左から右）
}
```

### 5.2 レイアウト計算

```dart
// レイアウト計算結果
final treeLayoutProvider = Provider<TreeLayout>((ref) {
  final persons = ref.watch(personsProvider).value ?? [];
  final relationships = ref.watch(relationshipsProvider).value ?? [];
  final orientation = ref.watch(displayOrientationProvider);
  
  // レイアウトエンジンでノード位置を計算
  return TreeLayoutEngine.calculateLayout(
    persons: persons,
    relationships: relationships,
    orientation: orientation,
  );
});

class TreeLayout {
  final List<PositionedPerson> positionedPersons;
  final List<PositionedRelationship> positionedRelationships;
  final Size requiredSize;
  
  // コンストラクタ
}

class PositionedPerson {
  final Person person;
  final Offset position;
  final Size size;
  
  // コンストラクタ
}

class PositionedRelationship {
  final Relationship relationship;
  final List<Offset> pathPoints;
  
  // コンストラクタ
}
```

## 6. パフォーマンス最適化

1. **レイアウト計算の最適化**
   - 人物・関係性の変更時のみ再計算
   - 複雑なレイアウト計算をワーカースレッドで実行（compute関数）

2. **描画の最適化**
   - 表示領域内のノードのみ描画（クリッピング）
   - 低解像度プレビューとスクロール停止時の高解像度描画

3. **キャッシング**
   - 計算済みレイアウトをキャッシュ
   - 人物ノードの描画をキャッシュ（RepaintBoundary）

## 7. 拡張性

1. **カスタマイズオプション**
   - ノードデザインのカスタマイズ
   - 関係線のスタイルカスタマイズ
   - 表示情報のカスタマイズ（名前のみ/詳細情報など）

2. **将来的な機能拡張**
   - 複数の家系図間のリンク
   - タイムライン表示（年代順）
   - フィルタリング（特定の枝だけ表示など）

## 8. テスト計画

### 8.1 ユニットテスト

- レイアウトアルゴリズムのテスト
  - 様々なケースでの位置計算の検証
  - エッジケースの処理確認

### 8.2 ウィジェットテスト

- 家系図表示ウィジェットのテスト
- ズーム・スクロール機能のテスト
- 表示切替機能のテスト

### 8.3 パフォーマンステスト

- 大規模家系図（100人以上）での描画パフォーマンス
- メモリ使用量の検証
